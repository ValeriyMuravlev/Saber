--SQL
--Таблица history находится в прикреплённом файле test.db (SQLite)
--history
--issue_key – уникальный ключ задачи
--status – статус задачи
--minutes_in_status – количество минут, которое задача находилась в статусе
--previous_status – предыдущий статус задачи
--started_at – время создания статуса задачи, unix миллисекунды 
--ended_at – время перехода задачи в другой статус, unix миллисекунды 


--SQL 1
--Напишите запрос, который выведет, сколько времени в среднем задачи каждой группы находятся в статусе “Open” 
--Условия:
--Под группой подразумевается первый символ в ключе задачи. Например, для ключа “C-40460” группой будет “C”
--Задача может переходить в один и тот же статус несколько раз.
--Переведите время в часы с округлением до двух знаков после запятой.
WITH ops as 
(
select
	substring(issue_key, 1, 1) as "Группа", 
	minutes_in_status
from history
where
	status = 'Open'
order by 1
)
select
	ops."Группа", 
	round(avg(minutes_in_status / 60),2) as "Ср.время задачи в группе "
from ops
group by 1



--SQL 2 
--Напишите запрос, который выведет ключ задачи, последний статус и его время создания для задач, которые открыты на данный момент времени.
--Условия:
--Открытыми считаются задачи, у которых последний статус в момент времени не “Closed” и не “Resolved”
--Задача может переходить в один и тот же статус несколько раз.
--Оформите запрос таким образом, чтобы, изменив дату, его можно было использовать для поиска открытых задач в любой момент времени в прошлом
--Переведите время в текстовое представление
with ops as 
(
SELECT 
    issue_key, 
    status, 
    strftime('%Y-%m-%d %H:%M:%S',  started_at / 1000, 'unixepoch') as started_at 
FROM history
WHERE 
    status NOT IN ('Closed', 'Resolved') AND 
    started_at >= (strftime('%s', '2022-12-01 00:00:00') * 1000) 
ORDER BY issue_key, started_at
)
select ops.issue_key, ops.status, max(ops.started_at) as "start date"
from ops
group by 1
